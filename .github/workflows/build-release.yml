name: Build & Release

on: [push]

# Prevent multiple builds running simultaneously
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Explicit permissions for security
permissions:
  contents: write  # For creating releases
  packages: write  # For publishing artifacts

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}

jobs:
  github-release:
    runs-on: ${{ matrix.runner }}

    # Platforms to build on/for
    strategy:
      matrix:
        include:
          # Linux x64
          - runner: ubuntu-24.04
            os: ubuntu
            arch: x64
          # Linux ARM64 (new native runners)
          - runner: ubuntu-24.04-arm
            os: ubuntu
            arch: arm64
          # Windows x64
          - runner: windows-2025
            os: windows
            arch: x64
          # macOS ARM64
          - runner: macos-15
            os: macos
            arch: arm64
          # macOS Intel x64
          - runner: macos-15-intel
            os: macos
            arch: x64

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v6

      - name: Install Node.js, NPM and yarn
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'yarn'

      - name: Install Snapcraft
        if: matrix.os == 'ubuntu'
        run: sudo snap install snapcraft --classic

      - name: Install libarchive-tools for pacman build # Related https://github.com/electron-userland/electron-builder/issues/4181
        if: matrix.os == 'ubuntu'
        run: |
          sudo apt-get update
          sudo apt-get install -y libarchive-tools

      - name: Install Flatpak build dependencies
        if: matrix.os == 'ubuntu'
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y --system flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08
          sudo flatpak install -y --system flathub org.electronjs.Electron2.BaseApp//24.08

      - name: Install dependencies
        run: yarn --frozen-lockfile

      - name: Build for test only linux
        if: |
          github.ref != 'refs/heads/main' &&
          matrix.os == 'ubuntu'
        run: yarn dist:linux:${{ matrix.arch }} -- --publish never

      - name: Release linux
        if: |
          github.ref == 'refs/heads/main' &&
          matrix.os == 'ubuntu'
        run: yarn dist:linux:${{ matrix.arch }} -- --publish always

      - name: Build for test only macos
        if: |
          github.ref != 'refs/heads/main' &&
          matrix.os == 'macos'
        run: yarn dist:mac:${{ matrix.arch }} -- --publish never

      - name: Release macos
        if: |
          github.ref == 'refs/heads/main' &&
          matrix.os == 'macos'
        run: yarn dist:mac:${{ matrix.arch }} -- --publish always

      - name: Build for test only windows
        if: |
          github.ref != 'refs/heads/main' &&
          matrix.os == 'windows'
        run: yarn dist:windows -- --publish never

      - name: Release windows
        if: |
          github.ref == 'refs/heads/main' &&
          matrix.os == 'windows'
        run: yarn dist:windows -- --publish always
